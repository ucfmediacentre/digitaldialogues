<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Digital Dialogues: Recent Changes</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
		<style type="text/css">td img {display: block;}</style>

        <link rel="stylesheet" href="<?php echo base_url(); ?>css/normalize.css">
        <link rel="stylesheet" href="<?php echo base_url(); ?>css/main.css">
        <script src="<?php echo base_url(); ?>js/vendor/jquery-1.8.3.min.js"></script>
        <style type="text/css">
            html, body {
				width:100%;
                height:100%;
                padding:0px;
                overflow:hidden;
                background-color:#ffe;
                -webkit-background-size: cover;
                -moz-background-size: cover;
                -o-background-size: cover;
                background-size: cover;
                color: #666;
                font-family: Calibri, Candara, Segoe, "Segoe UI", Optima, Arial, sans-serif;
                font-size: 1em
            }*/
        }
        #the-swarm {
		}
		
		#canvasDiv {
          position:absolute;
		  top:100px;
		}
		
        #the-swarm.linkable {
            cursor:pointer;
        }
        #arbor {
            position:absolute;
            min-height:100%;
            min-width:100%;
        }

		A:link {
		  color:#36c;
		  font-weight:bold;
		  text-decoration:none;
		}
		
		A:visited {
		  color:#339;
		  font-weight:bold;
		  text-decoration:none;
		}
		
		A:hover {
		  color:#39f;
		  font-weight:bold;text-decoration:none;
		}
        </style>
		<style type="text/css">td img {display: block;}</style>
		<script language="JavaScript1.2" type="text/javascript">
		<!--
		function MM_findObj(n, d) { //v4.01
		  var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {
			d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}
		  if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];
		  for(i=0;!x&&d.layers&&i<d.layers.length;i++) x=MM_findObj(n,d.layers[i].document);
		  if(!x && d.getElementById) x=d.getElementById(n); return x;
		}
		function MM_swapImage() { //v3.0
		  var i,j=0,x,a=MM_swapImage.arguments; document.MM_sr=new Array; for(i=0;i<(a.length-2);i+=3)
		   if ((x=MM_findObj(a[i]))!=null){document.MM_sr[j++]=x; if(!x.oSrc) x.oSrc=x.src; x.src=a[i+2];}
		}
		function MM_swapImgRestore() { //v3.0
		  var i,x,a=document.MM_sr; for(i=0;a&&i<a.length&&(x=a[i])&&x.oSrc;i++) x.src=x.oSrc;
		}
		
		function MM_preloadImages() { //v3.0
		  var d=document; if(d.images){ if(!d.MM_p) d.MM_p=new Array();
			var i,j=d.MM_p.length,a=MM_preloadImages.arguments; for(i=0; i<a.length; i++)
			if (a[i].indexOf("#")!=0){ d.MM_p[j]=new Image; d.MM_p[j++].src=a[i];}}
		}
		//-->
		</script>
    </head>
    
    <body bgcolor="#ffe" onload="MM_preloadImages('../../../img/logo_s2.gif','../../../img/recentChanges_s2.gif','../../../img/logOut_s2.gif','../../../img/mail_s2.gif','../../../img/sandpit_s2.gif','../../../img/help_s2.gif','../../../img/search_s2.gif','../../../img/newPage_s2.gif','../../../img/newText_s2.gif','../../../img/newImage_s2.gif','../../../img/newAudio_s2.gif','../../../img/newVideo_s2.gif');">
	<div id="navbar">
	  <table style="display: inline-table;" border="0" cellpadding="0" cellspacing="0" width="550">
	  <tr>
	   <td><img src="../../../img/spacer.gif" width="125" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="50" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="50" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="50" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="50" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="50" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="25" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="75" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="50" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="25" height="1" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="1" height="1" alt="" /></td>
	  </tr>
	
	  <tr>
	   <td><a href="../../../index.php/pages/view/Connected%20Communities/Home" onmouseout="MM_swapImgRestore();" onmouseover="MM_swapImage('logo','','../../../img/logo_s2.gif',1);"><img name="logo" src="../../../img/logo.gif" width="125" height="80" id="logo" alt="Website Home" /></a></td>
	   <td><a href="../../recentChanges?group=<?php echo $group; ?>" onmouseout="MM_swapImgRestore();" onmouseover="MM_swapImage('recentChanges','','../../../img/recentChanges_s2.gif',1);"><img name="recentChanges" src="../../../img/recentChanges.gif" width="50" height="80" id="recentChanges" alt="Recent changes" /></a></td>
	   <td><a href="../../verifylogin/log_out/pages/Connected%20Communities/Home" onmouseout="MM_swapImgRestore();" onmouseover="MM_swapImage('logOut','','../../../img/logOut_s2.gif',1);"><img name="logOut" src="../../../img/logOut.gif" width="50" height="80" id="logOut" alt="Log out" /></a></td>
	   <td><a href="../../messages/view/<?php echo $this->session->userdata('username'); ?>" onmouseout="MM_swapImgRestore();" onmouseover="MM_swapImage('mail','','../../../img/mail_s2.gif',1);"><img name="mail" src="../../../img/mail.gif" width="50" height="80" id="mail" alt="Mail" /></a></td>
	   <td><a href="../../../index.php/pages/view/Connected%20Communities/sandpit" onmouseout="MM_swapImgRestore();" onmouseover="MM_swapImage('sandpit','','../../../img/sandpit_s2.gif',1);"><img name="sandpit" src="../../../img/sandpit.gif" width="50" height="80" id="sandpit" alt="Sandpit" /></a></td>
	   <td><a href="../../../index.php/pages/view/Connected%20Communities/help" onmouseout="MM_swapImgRestore();" onmouseover="MM_swapImage('help','','../../../img/help_s2.gif',1);"><img name="help" src="../../../img/help.gif" width="50" height="80" id="help" alt="Help" /></a></td>
	   <td><img name="digitalDialoguesBar_r1_c9" src="../../../img/digitalDialoguesBar_r1_c9.png" width="25" height="80" id="digitalDialoguesBar_r1_c9" alt="" /></td>
	   <td><table><tr>
	   <td id="searchField" class="searchForm" nowrap="nowrap" align="center"><form id="searchForm" action="<?php echo base_url(); ?>index.php/search/map/<?php echo $group; ?>" method="get" enctype="multipart/form-data" id="filter_form">&nbsp;&nbsp;&nbsp;<input name="filter" value="" onchange="submit();" />&nbsp;&nbsp;&nbsp;</td>
	   </tr>
		<tr>
		  <td><img src="../../../img/spacer.gif" width="50" height="30" alt="" /></td>
		</tr>
	   </table></td>
	   <td><a onmouseout="MM_swapImgRestore(); $('#searchField').css('background-color', '#339');" onmouseover="MM_swapImage('search','','../../../img/search_s2.gif',1); $('#searchField').css('background-color', '#3c66b3');"><img name="search" src="../../../img/search.gif" width="50" height="80" id="search" alt="Search" /></a></form></td>
	   <td><img name="digitalDialoguesBar_r1_c15b" src="../../../img/digitalDialoguesBar_r1_c15.png" width="25" height="80" id="digitalDialoguesBar_r1_c15b" alt="" /></td>
	   <td><img src="../../../img/spacer.gif" width="1" height="80" alt="" /></td>
	  </tr>
	</table>
</div>
	
	<div id="page_title_wrapper">
	    <h1 id="page_title"> <?php echo $group; ?> : Search Map </h1>	
	</div>
        
			<div id="oldBrowser" style="display:none" width="600px">This website is a project designed to work with <strong>HTML5</strong>, so please download a modern browser if you can (its worth the wait!). If you haven't got IT permissions to do this, try Chrome portable (<a href="http://portableapps.com/apps/internet/google_chrome_portable">Chrome Portable</a>). You should be able to use that, OK. Otherwise, go straight to the home page here: <a href="<?php echo base_url(); ?>index.php/pages/view/<?php echo $group; ?>/home">Home</a>, and have a play around there. Thanks very much!<br /><br /><?php echo $listview; ?></div>
        <div id="canvasDiv"><canvas style="opacity: 1; display: inline;" id="the-swarm" width="100%" height="350"></canvas></div>
        <img id="bg" src="<?php echo base_url(); ?>img/cream.gif" style="display:none;" />
        <script src="<?php echo base_url(); ?>libraries/arbor/lib/arbor.js"></script>
        <script src="<?php echo base_url(); ?>libraries/arbor/lib/arbor-tween.js"></script>
        <script src="<?php echo base_url(); ?>libraries/arbor/lib/arbor-graphics.js"></script>
        <script type="text/javascript">
            (function ($) {
				
				if( !window.Worker) {
					$("#oldBrowser").css("display", "inline");
				} 

                var Renderer = function (elt) {
                    var dom = $(elt)
                    var canvas = dom.get(0)
                    var ctx = canvas.getContext("2d");
                    var gfx = arbor.Graphics(canvas);
                    var sys = null;
                    var img = document.getElementById("bg"); //from Al's coding

                    var selected = null,
                        nearest = null,
                        _mouseP = null;


                    var that = {
                        init: function (pSystem) {
                            sys = pSystem
                            sys.screen({
                                size: {
                                    width: dom.width(),
                                    height: dom.height()
                                },
                                padding: [36, 150, 150, 150]
                            })

                            $(window).resize(that.resize)
                            that.resize()
                            that._initMouseHandling()

                        },
                        resize: function () {
                            canvas.width = $(window).width()
                            canvas.height = $(window).height()
                            sys.screen({
                                size: {
                                    width: canvas.width - 50,
                                    height: canvas.height - 50
                                }
                            })
                            that.redraw()
                        },
                        redraw: function () {
                            gfx.clear()
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height); //from Al's code
                            sys.eachEdge(function (edge, p1, p2) {
                                gfx.line(p1, p2, {
                                    stroke: "gray",
                                    width: 2
                                });
                            })
                            sys.eachNode(function (node, pt) {
                                var w = Math.max(20, 20 + gfx.textWidth(node.name))
                                gfx.rect(pt.x - w / 2, pt.y - 8, w, 20, 4, {
                                    fill: "#3366cc",
                                    width: 2,
									stroke: node.data.stroke
                                });
                                //gfx.rect(pt.x-w/2, pt.y-8, w, 20, 4, {});
                                //gfx.text(node.name, pt.x, pt.y+5, {color:"orange", align:"center", font:"Arial", size:12});
                                gfx.text(node.name, pt.x, pt.y + 7, {
                                    color: "white",
                                    align: "center",
                                    font: "Arial",
                                    size: 12
                                });
                            })
                        },


                        _initMouseHandling: function () {
                            // no-nonsense drag and drop (thanks springy.js)
                            selected = null;
                            nearest = null;
                            var dragged = null;
                            var oldmass = 1

                            var _section = null

                            var handler = {
                                moved: function (e) {
                                    var pos = $(canvas).offset();
                                    _mouseP = arbor.Point(e.pageX - pos.left, e.pageY - pos.top)
                                    nearest = sys.nearest(_mouseP);

                                    if (!nearest.node) return false

                                    if (nearest.node.data.shape != 'dot') {
                                        selected = (nearest.distance < 50) ? nearest : null
                                        if (selected) {
                                            dom.addClass('linkable')
                                            window.status = selected.node.data.link.replace(/^\//, "http://" + window.location.host + "/").replace(/^#/, '')
                                        } else {
                                            dom.removeClass('linkable')
                                            window.status = ''
                                        }
                                    }

                                    return false
                                },
                                clicked: function (e) {
                                    var pos = $(canvas).offset();
                                    _mouseP = arbor.Point(e.pageX - pos.left, e.pageY - pos.top)
                                    nearest = dragged = sys.nearest(_mouseP);

                                    if (nearest && selected && nearest.node === selected.node) {
                                        var link = selected.node.data.link
                                        if (link.match(/^#/)) {
                                            $(that).trigger({
                                                type: "navigate",
                                                path: link.substr(1)
                                            })
                                        } else {
                                            window.location = link
                                        }
                                        return false
                                    }


                                    if (dragged && dragged.node !== null) dragged.node.fixed = true

                                    $(canvas).unbind('mousemove', handler.moved);
                                    $(canvas).bind('mousemove', handler.dragged)
                                    $(window).bind('mouseup', handler.dropped)

                                    return false
                                },
                                dragged: function (e) {
                                    var old_nearest = nearest && nearest.node._id
                                    var pos = $(canvas).offset();
                                    var s = arbor.Point(e.pageX - pos.left, e.pageY - pos.top)

                                    if (!nearest) return
                                    if (dragged !== null && dragged.node !== null) {
                                        var p = sys.fromScreen(s)
                                        dragged.node.p = p
                                    }

                                    return false
                                },

                                dropped: function (e) {
                                    if (dragged === null || dragged.node === undefined) return
                                    if (dragged.node !== null) dragged.node.fixed = false
                                    dragged.node.tempMass = 1000
                                    dragged = null;
                                    // selected = null
                                    $(canvas).unbind('mousemove', handler.dragged)
                                    $(window).unbind('mouseup', handler.dropped)
                                    $(canvas).bind('mousemove', handler.moved);
                                    _mouseP = null
                                    return false
                                }


                            }

                            $(canvas).mousedown(handler.clicked);
                            $(canvas).mousemove(handler.moved);

                        }
                    }

                    return that
                }

                $(document).ready(function () {

                    var links = <?php echo $links; ?> ;
					var strokeColour
					var UIstring = '';
					var edgeString = '';
					var nodeString = '';
					var edge = '';
					var pagesFound = new Array();;
					// create an array of just the pages found
					for (var i = 0; i < links.length; i++) {
					  pagesFound.push(links[i].title);
					}
					//iterate through the list of pages again and this time extract the edges needed
					for (var i = 0; i < links.length; i++) {
						strokeColour = '';
						//check to see if any pages have links
						if (links[i].link_tree.length > 0) {
							//create a string to represent each node(page) from which the edges(links) are to be drawn
							edgeString = edgeString + '"' + links[i].title + '":{';
							//search through all the links tree for the page to create the connections
							for (var j = 0; j < links[i].link_tree.length; j++) {
								edge = links[i].link_tree[j].linkTitle;
								
								//check to see that all nodes are in the pages found array
								for(var k=0;k<pagesFound.length;k++) {
									if(edge.toUpperCase() == pagesFound[k].toUpperCase()) {
										edgeString = edgeString + '"' + pagesFound[k] + '":{},'
									}
								}
							}
							//take off end comma if there were some edges found
							//otherwise it will leave the starting bracket by default
							if (edgeString.charAt(edgeString.length-1) == ","){
							  edgeString = edgeString.substr(0,edgeString.length-1);  
							}
							//terminate the object properly
							edgeString = edgeString + '},';
						}
						//build up the node string with title & link
						nodeString = nodeString + '"' + links[i].title;
						nodeString = nodeString + '":{"link":"<?php echo base_url(); ?>index.php/pages/view/'+ '<?php echo $group; ?>/' + links[i].title + '", ';
						//create a stroke colour but leave it blank for now
						nodeString = nodeString + '"stroke":""},';
						
					}
					//take off the end comas
					nodeString = nodeString.substr(0,nodeString.length-1);
					edgeString = edgeString.substr(0,edgeString.length-1);
					//construct the UIstring
					UIstring = '{"nodes":{';
					UIstring = UIstring + nodeString;
					UIstring = UIstring + '}, "edges":{';
					UIstring = UIstring + edgeString;
					UIstring = UIstring + '}}';
					var theUI = $.parseJSON(UIstring);
					
					// see how many times each page occurs across the edges(links) section of the array
					var node = "";
					var count
					var connections = new Array();
					$.each(theUI.edges, function(page, links) {
						$.each(links, function(item, value){
							connection = page+"°"+item;
							if($.inArray(connection, connections) < 0){
								//if this connection isnt already in the array then store it 
								connections.push(connection);
								//also store the reverse connection!
								connection = item+"°"+page;
								connections.push(connection);
							}
						})
					});
					
					var nodeNum = 0;
					$.each(theUI.nodes, function(key, value) {
						count=0;
						for (var m=0; m<connections.length; m++) {
							if (key === connections[m].split("°")[1]){
							  count++;
							}
						}
						if(count>2){
							this.stroke = "black";
						}
					});
					
					/*theUI.nodes["Recent Changes"].stroke = "cyan";
					theUI.nodes["Recent Changes"].link = "<?php echo base_url(); ?>index.php/recentChanges";
					theUI.nodes["Stream"].stroke = "cyan";
					theUI.nodes["Stream"].link = "<?php echo base_url(); ?>stream";*/
					
                    var sys = arbor.ParticleSystem();
                    sys.parameters({
                        stiffness: 900,
                        repulsion: 2000,
                        gravity: true,
                        dt: 0.015
                    })
					if (pagesFound.length === 1) {
						//Stop single nodes bouncing all over the place
						sys.parameters({ friction: '10.0' });
						sys.parameters({gravity:true, dt:0.0001}) 
					}
					
                    sys.renderer = Renderer("#the-swarm");
                    sys.graft(theUI);

                })
            })(this.jQuery)
        </script>

		<script language="JavaScript1.2" type="text/javascript">
		  <!--
		  $( "#search" ).click(function() {
			  $( "#searchForm" ).submit();
		  });
		  //-->
		</script>		
        <!-- Google Analytics -->
        <script>
			(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
		  
			ga('create', 'UA-47930876-1', 'digitaldialogues.org');
			ga('send', 'pageview');
		  
		</script>
    </body>

</html>